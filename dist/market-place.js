/*!
 * Name: market-place
 * Id: market-place
 * Version: 1.0.1
 * Description: Handle plugins descriptions, repo and versions. Publish the list to jsonbin.io
 * Author: Guido Bellomo (https://github.com/guidone)
 * Repository: http://red-bot.io
 */
define(["../../../src/components","../../src/components","code-plug","graphql-tag","lodash","react","react-apollo","rsuite","use-http"],(e,t,n,o,i,r,a,s,l)=>(()=>{var c={158:(e,t,n)=>{"use strict";n.r(t);var o=n(297),i=n.n(o),r=n(399),a=n(186),s=n(222),l=n(74),c=n(875),u=n.n(c),p=n(939),d=n.n(p),g=n(804),m=n.n(g);let f;null!=window.AppContext?f=window.AppContext:(f=i().createContext({}),window.AppContext=f);const y=f,h=()=>{const{state:e}=(0,o.useContext)(y);return e.settings};function b(){}const k=function(e,t){var n,o=0,i=1,r={},a=(t=t||{}).maxAttempts||1/0;return r.open=function(){(n=new WebSocket(e,t.protocols||[])).onmessage=t.onmessage||b,n.onopen=function(e){(t.onopen||b)(e),o=0},n.onclose=function(e){1e3===e.code||1001===e.code||1005===e.code||r.reconnect(e),(t.onclose||b)(e)},n.onerror=function(e){e&&"ECONNREFUSED"===e.code?r.reconnect(e):(t.onerror||b)(e)}},r.reconnect=function(e){i&&o++<a?i=setTimeout((function(){(t.onreconnect||b)(e),r.open()}),t.timeout||1e3):(t.onmaximum||b)(e)},r.json=function(e){n.send(JSON.stringify(e))},r.send=function(e){n.send(e)},r.close=function(e,t){i=clearTimeout(i),n.close(e||1e3,t)},r.open(),r},C=(n(719),function({url:e,maxAttempts:t=10,timeout:n=5e3}){let o={};const i=(e,...t)=>{null!=o[e]&&o[e].forEach(e=>e(...t))};console.log("opening sockette",e);const r=new k(e,{timeout:n,maxAttempts:t,onmessage:e=>{let t;try{t=JSON.parse(e.data)}catch(e){}i("message",t.topic,t.payload)},onerror:e=>{console.log("connet error",e)},onmaximum:e=>{console.log("connet error",e)},onreconnect:e=>i("reconnect"),onclose:e=>i("close"),onopen:e=>i("open")}),a={on:(e,t)=>(null==o[e]&&(o[e]=[]),o[e].push(t),a),off:(e,t)=>(null!=o[e]&&(o[e]=o[e].filter(e=>e!==t)),a),close:()=>(o={},r.close(),a),send:e=>(r.send(e),a)};return a});function E(){return(Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e}).apply(this,arguments)}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const w=i().createContext({});let x;class _ extends i().Component{constructor(e){super(e),v(this,"onMessage",(e,t)=>this.props.dispatch({type:"socket.message",topic:e,payload:t})),v(this,"onOpen",()=>{this.props.dispatch({type:"socket.open"}),s.Notification.success({title:"Connected!"})}),this.state={ws:null}}componentDidMount(){const{settings:e}=this.props;if(null==x){const t=window.location.protocol.includes("https")?"wss":"ws";console.log(`Created listening socket ${t}://${e.host}:1942`),x=new C({url:`${t}://${e.host}:1942`})}x.on("message",this.onMessage).on("open",()=>this.onOpen())}componentWillUnmount(){x.off("message",this.onMessage).off("open",this.onOpen)}render(){const{ws:e}=this.state;return i().createElement(w.Provider,{value:{socketListener:x}},this.props.children)}}S=_;var S;const P=u()`
query($namespace: String) {
  configurations(namespace: $namespace) {
    id
    namespace
    payload
  }
}
`,O=u()`
mutation($configuration: NewConfiguration!) {
  createConfiguration(configuration: $configuration) {
    id,
    namespace,
    payload
  }
}
`,j=({namespace:e,onCompleted:t=(()=>{}),onLoaded:n=(()=>{})})=>{const{loading:i,error:r,data:a}=(0,l.useQuery)(P,{variables:{namespace:e},onCompleted:e=>{let t;if(null!=e&&null!=e.configurations&&0!==e.configurations.length)try{t=JSON.parse(e.configurations[0].payload)}catch(e){}n(t)}}),{sendMessage:s}=(({reducer:e=(()=>{}),initialState:t={},onMessage:n=(()=>{})}={})=>{const{host:i}=h(),r=(e,t)=>{s({type:"socket.message",topic:e,payload:t}),n(e,t)};(0,o.useEffect)(()=>{if(null==x){const e=window.location.protocol.includes("https")?"wss":"ws";console.log(`Created listeing socket ${e}://${i}:1942`),x=new C({url:`${e}://${i}:1942`})}return x.on("message",r),()=>x.off("message",r)},[]);const[a,s]=(0,o.useReducer)(e,t);return{state:a,dispatch:s,sendMessage:(e,t)=>x.send(JSON.stringify({topic:e,payload:t}))}})();let c,u;if(null!=a&&null!=a.configurations&&0!==a.configurations.length)try{c=JSON.parse(a.configurations[0].payload)}catch(t){u=`Invalid JSON in configuration "${e}"`}const[p,{loading:d,error:g}]=(0,l.useMutation)(O,{onCompleted:t});return{loading:i,saving:d,error:r||g||u,data:c,update:t=>{p({variables:{configuration:{namespace:e,payload:JSON.stringify(t)}}}),s("mc.configuration",{namespace:e,...t})}}},M=u()`
query {
  contents(namespace: "plugins") {
    id,
    title,
    body,
    payload,
    fields {
      name,
      value
    }
  }
}
`,N=()=>{const e=(0,l.useApolloClient)(),{data:t}=j({namespace:"market-place"}),[n,r]=(0,o.useState)(null),{put:a}=d()("https://api.jsonbin.io",{headers:{"Content-Type":"application/json","secret-key":null!=t?t.jsonbin_key:null,versioning:"false"}}),c=null!=t&&!m().isEmpty(t.jsonbin_key);return i().createElement(s.Button,{disabled:null!=n||!c,appearance:"primary",onClick:async()=>{r("Loading...");const n=(await e.query({query:M,fetchPolicy:"network-only"})).data.contents.map(e=>{const t=e.fields.reduce((e,t)=>({...e,[t.name]:t.value}),{});let n=null;return m().isEmpty(t.content_title)&&m().isEmpty(t.content_slug)&&m().isEmpty(t.content_body)||(n={title:t.content_title,slug:t.content_slug,body:t.content_body,namespace:t.content_namespace}),{id:t.id,name:e.title,description:e.body,url:t.url,flow:t.flow,version:t.version,github:t.github,keywords:t.tags,author:{name:t.author,url:t.author_url},content:n,initialConfiguration:null==e.payload||m().isEmpty(e.payload.initial_configuration)?null:e.payload.initial_configuration}});r("Publishing..."),await a("/b/"+t.jsonbin_id,n),r(null),s.Notification.success({title:"Published",description:"Plugin list published succesfully "})}},null!=n?n:"Publish plugins")};var T=n(738);const $=({formValue:e={},onChange:t=(()=>{})})=>{const{initial_configuration:n}=e||{};return i().createElement("div",{style:{paddingBottom:"15px"}},i().createElement(T.JsonEditor,{value:m().isEmpty(n)?"":n,height:"55vh",onChange:n=>{t({...e,initial_configuration:m().isEmpty(n)?null:n})}}))};(0,r.plug)("sidebar",null,{id:"market-place",label:"Market Place",url:"/market-place",icon:"shopping-basket"}),(0,r.plug)("sidebar",null,{id:"configuration",label:"Configuration",permission:"configure",icon:"cog",options:[{id:"configuration-market-place",label:"Market Place",url:"/configuration-market-place"}]}),(0,r.plug)("pages",(0,a.withConfigurationPage)("market-place",({value:e,onSubmit:t=(()=>{}),disabled:n=!1})=>{const[r,a]=(0,o.useState)(e),[l,c]=(0,o.useState)(null),u=(0,o.useRef)(null);return i().createElement("div",null,i().createElement(s.Form,{formValue:r,formError:l,ref:u,checkTrigger:"none",layout:"vertical",fluid:!0,onChange:e=>{a(e),c(null)},onCheck:e=>{c(e)}},i().createElement(s.FormGroup,null,i().createElement(s.ControlLabel,null,"JSONbin.io id"),i().createElement(s.FormControl,{name:"jsonbin_id",accepter:s.Input,disabled:n}),i().createElement(s.HelpBlock,null,"The ",i().createElement("em",null,"id")," of the ",i().createElement("strong",null,"jsonbin.io")," snippet of the plugins meta info")),i().createElement(s.FormGroup,null,i().createElement(s.ControlLabel,null,"JSONbin.io key"),i().createElement(s.FormControl,{name:"jsonbin_key",accepter:s.Input,disabled:n}),i().createElement(s.HelpBlock,null,"The ",i().createElement("em",null,"secret key")," to write on ",i().createElement("strong",null,"jsonbin.io"))),i().createElement(s.FormGroup,{style:{marginTop:"40px"}},i().createElement(s.ButtonToolbar,null,i().createElement(s.Button,{disabled:n,appearance:"primary",onClick:()=>{u.current.check()&&t(r)}},"Save configuration"),i().createElement(s.Button,{disabled:n,appearance:"default",onClick:()=>{confirm("Reset configuration?")&&a(e)}},"Reset")))))},{Legend:()=>i().createElement("div",null,"Configure the id and the key to access ",i().createElement("strong",null,"jsonbing.io")," for the plugins met information.",i().createElement("br",null),"Docs about the API ",i().createElement("a",{href:"https://jsonbin.io/api-reference/bins/read",target:"blank"},"here"),"."),title:"Market Place"}),{permission:"configure",url:"/configuration-market-place",title:"Market Place",id:"configuration"}),(0,r.plug)("pages",a.Content.Contents,{url:"/market-place",title:"Market Place",id:"market-place",namespace:"plugins",breadcrumbs:["Market Place","Plugins"],labels:{saveContent:"Save plugin",createContent:"Create plugin",emptyContent:"No plugins"},custom:()=>i().createElement(N,null),customFieldsSchema:[{key:"url",type:"string",description:"URL of the compiled plugin",color:"cyan"},{key:"flow",type:"string",description:"URL of the Node-RED flow for this plugin",color:"cyan"},{key:"id",type:"string",description:"Unique id of the plugin",color:"red"},{key:"version",type:"string",description:"The version of the current (latest) plugin",color:"red"},{key:"github",type:"string",description:"The URL of the github page of the plugin",color:"red"},{key:"author",type:"string",description:"The username of the author of the plugin",color:"orange"},{key:"author_url",type:"string",description:"The home page of the username, if any",color:"orange"},{key:"tags",type:"tags",description:"List of keywords, comma separated",color:"red"},{key:"content_title",type:"string",description:"Create a content with this title",color:"violet"},{key:"content_slug",type:"string",description:"Create a content with this slug",color:"violet"},{key:"content_body",type:"string",description:"Create a content with this body",color:"violet"},{key:"content_namespace",type:"string",description:"Create a content with this namespace",color:"violet"}]}),(0,r.plug)("content-tabs",$,{id:"content-configuration",label:"Configuration",namespace:["plugins"]})},719:e=>{e.exports={wsPort:1942,notificationPort:1943}},738:t=>{"use strict";t.exports=e},186:e=>{"use strict";e.exports=t},399:e=>{"use strict";e.exports=n},875:e=>{"use strict";e.exports=o},804:e=>{"use strict";e.exports=i},297:e=>{"use strict";e.exports=r},74:e=>{"use strict";e.exports=a},222:e=>{"use strict";e.exports=s},939:e=>{"use strict";e.exports=l}},u={};function p(e){if(u[e])return u[e].exports;var t=u[e]={exports:{}};return c[e](t,t.exports,p),t.exports}return p.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return p.d(t,{a:t}),t},p.d=(e,t)=>{for(var n in t)p.o(t,n)&&!p.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},p.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),p.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},p(158)})());