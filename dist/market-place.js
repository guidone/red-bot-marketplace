/*!
 * Name: market-place
 * Id: market-place
 * Version: 1.0.0
 * Description: Handle plugins descriptions, repo and versions. Publish the list to jsonbin.io
 * Author: Guido Bellomo (https://github.com/guidone)
 * Repository: http://red-bot.io
 */
define(["../../../src/components","../../src/components","code-plug","graphql-tag","lodash","react","react-apollo","rsuite","use-http"],(e,t,n,o,r,i,a,l,s)=>(()=>{var c={718:(e,t,n)=>{"use strict";n.r(t);var o=n(297),r=n.n(o),i=n(399),a=n(186),l=n(222),s=n(74),c=n(875),u=n.n(c),p=n(939),d=n.n(p),g=n(804),m=n.n(g);function f(){}const y=function(e,t){var n,o=0,r=1,i={},a=(t=t||{}).maxAttempts||1/0;return i.open=function(){(n=new WebSocket(e,t.protocols||[])).onmessage=t.onmessage||f,n.onopen=function(e){(t.onopen||f)(e),o=0},n.onclose=function(e){1e3===e.code||1001===e.code||1005===e.code||i.reconnect(e),(t.onclose||f)(e)},n.onerror=function(e){e&&"ECONNREFUSED"===e.code?i.reconnect(e):(t.onerror||f)(e)}},i.reconnect=function(e){r&&o++<a?r=setTimeout((function(){(t.onreconnect||f)(e),i.open()}),t.timeout||1e3):(t.onmaximum||f)(e)},i.json=function(e){n.send(JSON.stringify(e))},i.send=function(e){n.send(e)},i.close=function(e,t){r=clearTimeout(r),n.close(e||1e3,t)},i.open(),i},h=new function({url:e,maxAttempts:t=10,timeout:n=5e3}){let o={};const r=(e,...t)=>{null!=o[e]&&o[e].forEach(e=>e(...t))};console.log("opening sockette",e);const i=new y(e,{timeout:n,maxAttempts:t,onmessage:e=>{let t;try{t=JSON.parse(e.data)}catch(e){}r("message",t.topic,t.payload)},onerror:e=>{console.log("connet error",e)},onmaximum:e=>{console.log("connet error",e)},onreconnect:e=>r("reconnect"),onclose:e=>r("close"),onopen:e=>r("open")}),a={on:(e,t)=>(null==o[e]&&(o[e]=[]),o[e].push(t),a),off:(e,t)=>(null!=o[e]&&(o[e]=o[e].filter(e=>e!==t)),a),close:()=>(o={},i.close(),a),send:e=>(i.send(e),a)};return a}({url:"ws://localhost:"+n(719).wsPort}),b=({reducer:e=(()=>{}),initialState:t={},onMessage:n=(()=>{})}={})=>{const r=(e,t)=>{a({type:"socket.message",topic:e,payload:t}),n(e,t)};(0,o.useEffect)(()=>(h.on("message",r),()=>h.off("message",r)),[]);const[i,a]=(0,o.useReducer)(e,t);return{state:i,dispatch:a,sendMessage:(e,t)=>h.send(JSON.stringify({topic:e,payload:t}))}},k=u()`
query($namespace: String) {
  configurations(namespace: $namespace) {
    id
    namespace
    payload
  }
}
`,E=u()`
mutation($configuration: NewConfiguration!) {
  createConfiguration(configuration: $configuration) {
    id,
    namespace,
    payload
  }
}
`,v=({namespace:e,onCompleted:t=(()=>{}),onLoaded:n=(()=>{})})=>{const{loading:o,error:r,data:i}=(0,s.useQuery)(k,{variables:{namespace:e},onCompleted:e=>{let t;if(null!=e&&null!=e.configurations&&0!==e.configurations.length)try{t=JSON.parse(e.configurations[0].payload)}catch(e){}n(t)}}),{sendMessage:a}=b();let l,c;if(null!=i&&null!=i.configurations&&0!==i.configurations.length)try{l=JSON.parse(i.configurations[0].payload)}catch(t){c=`Invalid JSON in configuration "${e}"`}const[u,{loading:p,error:d}]=(0,s.useMutation)(E,{onCompleted:t});return{loading:o,saving:p,error:r||d||c,data:l,update:t=>{u({variables:{configuration:{namespace:e,payload:JSON.stringify(t)}}}),a("mc.configuration",{namespace:e,...t})}}},C=u()`
query {
  contents(namespace: "plugins") {
    id,
    title,
    body,
    payload,
    fields {
      name,
      value
    }
  }
}
`,S=()=>{const e=(0,s.useApolloClient)(),{data:t}=v({namespace:"market-place"}),[n,i]=(0,o.useState)(null),{put:a}=d()("https://api.jsonbin.io",{headers:{"Content-Type":"application/json","secret-key":null!=t?t.jsonbin_key:null,versioning:"false"}}),c=null!=t&&!m().isEmpty(t.jsonbin_key);return r().createElement(l.Button,{disabled:null!=n||!c,appearance:"primary",onClick:async()=>{i("Loading...");const n=(await e.query({query:C,fetchPolicy:"network-only"})).data.contents.map(e=>{const t=e.fields.reduce((e,t)=>({...e,[t.name]:t.value}),{});let n=null;return m().isEmpty(t.content_title)&&m().isEmpty(t.content_slug)&&m().isEmpty(t.content_body)||(n={title:t.content_title,slug:t.content_slug,body:t.content_body}),{id:t.id,name:e.title,description:e.body,url:t.url,flow:t.flow,version:t.version,github:t.github,keywords:t.tags,author:{name:t.author,url:t.author_url},content:n,initialConfiguration:null==e.payload||m().isEmpty(e.payload.initial_configuration)?null:e.payload.initial_configuration}});i("Publishing..."),await a("/b/"+t.jsonbin_id,n),i(null),l.Notification.success({title:"Published",description:"Plugin list published succesfully "})}},null!=n?n:"Publish plugins")};var _=n(738);const w=({formValue:e={},onChange:t=(()=>{})})=>{const{initial_configuration:n}=e||{};return r().createElement("div",{style:{paddingBottom:"15px"}},r().createElement(_.JsonEditor,{value:m().isEmpty(n)?"":n,height:"55vh",onChange:n=>{t({...e,initial_configuration:m().isEmpty(n)?null:n})}}))};(0,i.plug)("sidebar",null,{id:"market-place",label:"Market Place",url:"/market-place",icon:"shopping-basket"}),(0,i.plug)("sidebar",null,{id:"configuration",label:"Configuration",permission:"configure",icon:"cog",options:[{id:"configuration-market-place",label:"Market Place",url:"/configuration-market-place"}]}),(0,i.plug)("pages",(0,a.withConfigurationPage)("market-place",({value:e,onSubmit:t=(()=>{}),disabled:n=!1})=>{const[i,a]=(0,o.useState)(e),[s,c]=(0,o.useState)(null),u=(0,o.useRef)(null);return r().createElement("div",null,r().createElement(l.Form,{formValue:i,formError:s,ref:u,checkTrigger:"none",layout:"vertical",fluid:!0,onChange:e=>{a(e),c(null)},onCheck:e=>{c(e)}},r().createElement(l.FormGroup,null,r().createElement(l.ControlLabel,null,"JSONbin.io id"),r().createElement(l.FormControl,{name:"jsonbin_id",accepter:l.Input,disabled:n}),r().createElement(l.HelpBlock,null,"The ",r().createElement("em",null,"id")," of the ",r().createElement("strong",null,"jsonbin.io")," snippet of the plugins meta info")),r().createElement(l.FormGroup,null,r().createElement(l.ControlLabel,null,"JSONbin.io key"),r().createElement(l.FormControl,{name:"jsonbin_key",accepter:l.Input,disabled:n}),r().createElement(l.HelpBlock,null,"The ",r().createElement("em",null,"secret key")," to write on ",r().createElement("strong",null,"jsonbin.io"))),r().createElement(l.FormGroup,{style:{marginTop:"40px"}},r().createElement(l.ButtonToolbar,null,r().createElement(l.Button,{disabled:n,appearance:"primary",onClick:()=>{u.current.check()&&t(i)}},"Save configuration"),r().createElement(l.Button,{disabled:n,appearance:"default",onClick:()=>{confirm("Reset configuration?")&&a(e)}},"Reset")))))},{Legend:()=>r().createElement("div",null,"Configure the id and the key to access ",r().createElement("strong",null,"jsonbing.io")," for the plugins met information.",r().createElement("br",null),"Docs about the API ",r().createElement("a",{href:"https://jsonbin.io/api-reference/bins/read",target:"blank"},"here"),"."),title:"Market Place"}),{permission:"configure",url:"/configuration-market-place",title:"Market Place",id:"configuration"}),(0,i.plug)("pages",a.Content.Contents,{url:"/market-place",title:"Market Place",id:"market-place",namespace:"plugins",breadcrumbs:["Market Place","Plugins"],labels:{saveContent:"Save plugin",createContent:"Create plugin",emptyContent:"No plugins"},custom:()=>r().createElement(S,null),customFieldsSchema:[{key:"url",type:"string",description:"URL of the compiled plugin",color:"cyan"},{key:"flow",type:"string",description:"URL of the Node-RED flow for this plugin",color:"cyan"},{key:"id",type:"string",description:"Unique id of the plugin",color:"red"},{key:"version",type:"string",description:"The version of the current (latest) plugin",color:"red"},{key:"github",type:"string",description:"The URL of the github page of the plugin",color:"red"},{key:"author",type:"string",description:"The username of the author of the plugin",color:"orange"},{key:"author_url",type:"string",description:"The home page of the username, if any",color:"orange"},{key:"tags",type:"tags",description:"List of keywords, comma separated",color:"red"},{key:"content_title",type:"string",description:"Create a content with this title",color:"violet"},{key:"content_slug",type:"string",description:"Create a content with this slug",color:"violet"},{key:"content_body",type:"string",description:"Create a content with this body",color:"violet"}]}),(0,i.plug)("content-tabs",w,{id:"content-configuration",label:"Configuration",namespace:["plugins"]})},719:e=>{e.exports={wsPort:1942,notificationPort:1943}},738:t=>{"use strict";t.exports=e},186:e=>{"use strict";e.exports=t},399:e=>{"use strict";e.exports=n},875:e=>{"use strict";e.exports=o},804:e=>{"use strict";e.exports=r},297:e=>{"use strict";e.exports=i},74:e=>{"use strict";e.exports=a},222:e=>{"use strict";e.exports=l},939:e=>{"use strict";e.exports=s}},u={};function p(e){if(u[e])return u[e].exports;var t=u[e]={exports:{}};return c[e](t,t.exports,p),t.exports}return p.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return p.d(t,{a:t}),t},p.d=(e,t)=>{for(var n in t)p.o(t,n)&&!p.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},p.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),p.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},p(718)})());