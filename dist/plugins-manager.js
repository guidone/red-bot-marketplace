/*!
 * Name: market-place
 * Id: market-place
 * Version: 1.0.2
 * Description: Handle plugins descriptions, repo and versions. Publish the list to jsonbin.io
 * Author: Guido Bellomo (https://github.com/guidone)
 * Repository: http://red-bot.io
 */
define(["react","code-plug","../../src/components","rsuite","react-apollo","graphql-tag","use-http","lodash","../../../src/components"],(e,n,t,o,i,s,r,a,l)=>(()=>{var c={478:(e,n,t)=>{"use strict";t.r(n);var o=t(297),i=t.n(o),s=t(875),r=t.n(s),a=t(222),l=t(804),c=t.n(l),u=t(74),p=t(399),g=t(738),d=t(186),m=t(939),f=t.n(m);let y;null!=window.AppContext?y=window.AppContext:(y=i().createContext({}),window.AppContext=y);const h=y,b=()=>{const{state:e}=(0,o.useContext)(h);return e.settings};function E(){}function C(e,n){var t,o=0,i=1,s={},r=(n=n||{}).maxAttempts||1/0;return s.open=function(){(t=new WebSocket(e,n.protocols||[])).onmessage=n.onmessage||E,t.onopen=function(e){(n.onopen||E)(e),o=0},t.onclose=function(e){1e3===e.code||1001===e.code||1005===e.code||s.reconnect(e),(n.onclose||E)(e)},t.onerror=function(e){e&&"ECONNREFUSED"===e.code?s.reconnect(e):(n.onerror||E)(e)}},s.reconnect=function(e){i&&o++<r?i=setTimeout((function(){(n.onreconnect||E)(e),s.open()}),n.timeout||1e3):(n.onmaximum||E)(e)},s.json=function(e){t.send(JSON.stringify(e))},s.send=function(e){t.send(e)},s.close=function(e,n){i=clearTimeout(i),t.close(e||1e3,n)},s.open(),s}t(719);const v=function({url:e,maxAttempts:n=10,timeout:t=5e3}){let o={};const i=(e,...n)=>{null!=o[e]&&o[e].forEach(e=>e(...n))};console.log("opening sockette",e);const s=new C(e,{timeout:t,maxAttempts:n,onmessage:e=>{let n;try{n=JSON.parse(e.data)}catch(e){}i("message",n.payload.topic,n.payload.payload)},onerror:e=>{console.log("connet error",e)},onmaximum:e=>{console.log("connet error",e)},onreconnect:e=>i("reconnect"),onclose:e=>i("close"),onopen:e=>i("open")}),r={on:(e,n)=>(null==o[e]&&(o[e]=[]),o[e].push(n),r),off:(e,n)=>(null!=o[e]&&(o[e]=o[e].filter(e=>e!==n)),r),close:()=>(o={},s.close(),r),send:e=>(s.send(e),r)};return r};function w(){return(Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)}function k(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}const x=i().createContext({});let S;class _ extends i().Component{constructor(e){super(e),k(this,"onMessage",(e,n)=>{this.props.dispatch({type:"socket.message",topic:e,payload:n})}),k(this,"onOpen",()=>{this.props.dispatch({type:"socket.open"}),a.Notification.success({title:"Connected!"})}),this.state={ws:null}}componentDidMount(){const{settings:e,accountId:n}=this.props;if(null==S){const n=window.location.protocol.includes("https")?"wss":"ws",t=c().isEmpty(e.accountId)?":"+e.port:"",o=`${n}://${e.host}${t}${c().isEmpty(e.accountId)?"":"/"+e.accountId}/mc-socket`;S=new v({url:o})}S.on("message",this.onMessage).on("open",()=>this.onOpen())}componentWillUnmount(){S.off("message",this.onMessage).off("open",this.onOpen)}render(){const{ws:e}=this.state;return i().createElement(x.Provider,{value:{socketListener:S}},this.props.children)}}P=_;var P;const j=r()`
query($namespace: String) {
  configurations(namespace: $namespace) {
    id
    namespace
    payload
  }
}
`,O=r()`
mutation($configuration: NewConfiguration!) {
  createConfiguration(configuration: $configuration) {
    id,
    namespace,
    payload
  }
}
`,M=({namespace:e,onCompleted:n=(()=>{}),onLoaded:t=(()=>{})})=>{const{loading:i,error:s,data:r}=(0,u.useQuery)(j,{variables:{namespace:e},onCompleted:e=>{let n;if(null!=e&&null!=e.configurations&&0!==e.configurations.length)try{n=JSON.parse(e.configurations[0].payload)}catch(e){}t(n)}}),{sendMessage:a}=(({reducer:e=(()=>{}),initialState:n={},onMessage:t=(()=>{})}={})=>{const{host:i,accountId:s,port:r}=b(),a=(e,n)=>{u({type:"socket.message",topic:e,payload:n}),t(e,n)};(0,o.useEffect)(()=>{if(null==S){const e=window.location.protocol.includes("https")?"wss":"ws",n=c().isEmpty(s)?":"+r:"",t=`${e}://${i}${n}${c().isEmpty(s)?"":"/"+s}/mc-socket`;S=new v({url:t})}return S.on("message",a),()=>S.off("message",a)},[]);const[l,u]=(0,o.useReducer)(e,n);return{state:l,dispatch:u,sendMessage:(e,n)=>S.send(JSON.stringify({topic:e,payload:n})),sendToInput:(e,n)=>S.send(JSON.stringify({topic:e,payload:n}))}})();let l,p;if(null!=r&&null!=r.configurations&&0!==r.configurations.length)try{l=JSON.parse(r.configurations[0].payload)}catch(n){p=`Invalid JSON in configuration "${e}"`}const[g,{loading:d,error:m}]=(0,u.useMutation)(O,{onCompleted:n});return{loading:i,saving:d,error:s||m||p,data:l,update:n=>{g({variables:{configuration:{namespace:e,payload:JSON.stringify(n)}}}),a("mc.configuration",{namespace:e,...n})}}},N=r()`
query {
  contents(namespace: "plugins") {
    id,
    title,
    body,
    payload,
    fields {
      name,
      value
    }
  }
}
`,I=()=>{const e=(0,u.useApolloClient)(),{data:n}=M({namespace:"plugins-manager"}),[t,s]=(0,o.useState)(null),{put:r}=f()("https://api.jsonbin.io",{headers:{"Content-Type":"application/json","secret-key":null!=n?n.jsonbin_key:null,versioning:"false"}}),l=null!=n&&!c().isEmpty(n.jsonbin_key);return i().createElement(a.Button,{disabled:null!=t||!l,appearance:"primary",onClick:async()=>{s("Loading...");const t=(await e.query({query:N,fetchPolicy:"network-only"})).data.contents.map(e=>{const n=e.fields.reduce((e,n)=>({...e,[n.name]:n.value}),{});let t=null;return c().isEmpty(n.content_title)&&c().isEmpty(n.content_slug)&&c().isEmpty(n.content_body)||(t={title:n.content_title,slug:n.content_slug,body:n.content_body,namespace:n.content_namespace}),{id:n.id,name:e.title,description:e.body,projectId:n.projectId,version:n.version,keywords:n.tags,flow:n.flow,author:{name:n.author,url:n.author_url},content:t,initialConfiguration:null==e.payload||c().isEmpty(e.payload.initial_configuration)?null:e.payload.initial_configuration}});s("Publishing..."),await r("/b/"+n.jsonbin_id,t),s(null),a.Notification.success({title:"Published",description:"Plugin list published succesfully "})}},null!=t?t:"Publish plugins")},T=({formValue:e={},onChange:n=(()=>{})})=>{const{initial_configuration:t}=e||{};return i().createElement("div",{style:{paddingBottom:"15px"}},i().createElement(g.JsonEditor,{value:c().isEmpty(t)?"":t,height:"55vh",onChange:t=>{n({...e,initial_configuration:c().isEmpty(t)?null:t})}}))};(0,p.plug)("sidebar",null,{id:"mission-control",label:"Mission Control",permission:"admins",icon:"rocket",options:[{id:"plugins-manager",label:"Plugins palette",permission:"plugins.manager",url:"/plugins-manager"}]}),(0,p.plug)("sidebar",null,{id:"configuration",order:9999,label:"Configuration",permission:"plugins.manager",icon:"cog",options:[{id:"configuration-plugins-manager",label:"Plugins Manager",url:"/configuration-plugins-lists-manager"}]}),(0,p.plug)("pages",(0,d.withConfigurationPage)("plugins-manager",({value:e,onSubmit:n=(()=>{}),disabled:t=!1})=>{const[s,r]=(0,o.useState)(e),[l,c]=(0,o.useState)(null),u=(0,o.useRef)(null);return i().createElement("div",null,i().createElement(a.Form,{formValue:s,formError:l,ref:u,checkTrigger:"none",layout:"vertical",fluid:!0,onChange:e=>{r(e),c(null)},onCheck:e=>{c(e)}},i().createElement(a.FormGroup,null,i().createElement(a.ControlLabel,null,"JSONbin.io id"),i().createElement(a.FormControl,{name:"jsonbin_id",accepter:a.Input,disabled:t}),i().createElement(a.HelpBlock,null,"The ",i().createElement("em",null,"id")," of the ",i().createElement("strong",null,"jsonbin.io")," snippet of the plugins meta info")),i().createElement(a.FormGroup,null,i().createElement(a.ControlLabel,null,"JSONbin.io key"),i().createElement(a.FormControl,{name:"jsonbin_key",accepter:a.Input,disabled:t}),i().createElement(a.HelpBlock,null,"The ",i().createElement("em",null,"secret key")," to write on ",i().createElement("strong",null,"jsonbin.io"))),i().createElement(a.FormGroup,{style:{marginTop:"40px"}},i().createElement(a.ButtonToolbar,null,i().createElement(a.Button,{disabled:t,appearance:"primary",onClick:()=>{u.current.check()&&n(s)}},"Save configuration"),i().createElement(a.Button,{disabled:t,appearance:"default",onClick:()=>{confirm("Reset configuration?")&&r(e)}},"Reset")))))},{Legend:()=>i().createElement("div",null,"Configure the id and the key to access ",i().createElement("strong",null,"jsonbing.io")," for the plugins met information.",i().createElement("br",null),"Docs about the API ",i().createElement("a",{href:"https://jsonbin.io/api-reference/bins/read",target:"blank"},"here"),"."),title:"Plugins Manager"}),{permission:"plugins.manager",url:"/configuration-plugins-lists-manager",title:"Plugins Manager",id:"configuration"}),(0,p.plug)("pages",d.Content.Contents,{url:"/plugins-manager",title:"Plugins Manager",id:"plugins-manager",namespace:"plugins",breadcrumbs:["Plugins Manager","Plugins"],labels:{saveContent:"Save plugin",createContent:"Create plugin",emptyContent:"No plugins"},custom:()=>i().createElement(I,null),customFieldsSchema:[{key:"flow",type:"boolean",description:"URL of the Node-RED flow for this plugin",color:"cyan"},{key:"id",type:"string",description:"Unique id of the plugin",color:"red"},{key:"version",type:"string",description:"The version of the current (latest) plugin",color:"red"},{key:"projectId",type:"string",description:"The project ID of the plugin repo in GitLab",color:"red"},{key:"tags",type:"tags",description:"List of keywords, comma separated",color:"red"},{key:"content_title",type:"string",description:"Create a content with this title",color:"violet"},{key:"content_slug",type:"string",description:"Create a content with this slug",color:"violet"},{key:"content_body",type:"string",description:"Create a content with this body",color:"violet"},{key:"content_namespace",type:"string",description:"Create a content with this namespace",color:"violet"}]}),(0,p.plug)("content-tabs",T,{id:"content-configuration",label:"Configuration",namespace:["plugins"]}),(0,p.plug)("permissions",null,{permission:"plugins.manager",name:"Plugins Manager",description:"Add and edit plugins",group:"General"})},719:e=>{e.exports={wsPort:1942,notificationPort:1943}},738:e=>{"use strict";e.exports=l},186:e=>{"use strict";e.exports=t},399:e=>{"use strict";e.exports=n},875:e=>{"use strict";e.exports=s},804:e=>{"use strict";e.exports=a},297:n=>{"use strict";n.exports=e},74:e=>{"use strict";e.exports=i},222:e=>{"use strict";e.exports=o},939:e=>{"use strict";e.exports=r}},u={};function p(e){if(u[e])return u[e].exports;var n=u[e]={exports:{}};return c[e](n,n.exports,p),n.exports}return p.n=e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return p.d(n,{a:n}),n},p.d=(e,n)=>{for(var t in n)p.o(n,t)&&!p.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:n[t]})},p.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n),p.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},p(478)})());